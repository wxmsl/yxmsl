<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Simyo ESIM 管理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.min.js"></script>
    <style>
        .step-card { margin: 20px 0; border-left: 4px solid #0d6efd; }
        .response-area { 
            background: #f8f9fa; 
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .qr-container { 
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="container py-4">
    <h1 class="mb-4">Simyo ESIM 管理控制台</h1>

    <!-- 全局状态 -->
    <div class="alert alert-info">
        当前会话状态: 
        <span id="sessionStatus">未登录</span> | 
        Activation Code: <span id="activationCodeStatus">未获取</span>
    </div>

    <!-- 第1步：登录 -->
    <div class="card step-card">
        <div class="card-body">
            <h5>1. 登录账号</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="phoneNumber" class="form-control" placeholder="电话号码 06xxxxxxxx">
                </div>
                <div class="col-md-4">
                    <input type="password" id="password" class="form-control" placeholder="密码">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="login()">登录</button>
                </div>
            </div>
            <div id="loginResponse" class="response-area"></div>
        </div>
    </div>

    <!-- 第2步：设备更换 -->
    <div class="card step-card">
        <div class="card-body">
            <h5>2. 设备更换操作</h5>
            <div class="row g-2 mb-3">
                <div class="col">
                    <button class="btn btn-warning" onclick="requestEsimChange()">2.1 申请新ESIM</button>
                </div>
                <div class="col">
                    <button class="btn btn-warning" onclick="resendCode()">2.2 重发验证码</button>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="validationCode" class="form-control" placeholder="验证码（6位数字）">
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning w-100" onclick="verifyCode()">2.3 验证确认</button>
                </div>
            </div>
            <div id="deviceChangeResponse" class="response-area"></div>
        </div>
    </div>

    <!-- 第3-5步：ESIM管理 -->
    <div class="card step-card">
        <div class="card-body">
            <h5>3. ESIM 管理</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <button class="btn btn-success" onclick="getEsim()">3. 获取ESIM</button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info" onclick="generateQR()">4. 生成二维码</button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-danger" onclick="confirmInstall()">5. 确认安装</button>
                </div>
            </div>
            <div id="esimResponse" class="response-area"></div>
            <div id="qrCodeContainer" class="qr-container"></div>
        </div>
    </div>

<script>
// 全局状态存储
let state = {
    sessionToken: null,
    activationCode: null
};

// 通用请求头
const commonHeaders = {
    'X-Client-Token': 'e77b7e2f43db41bb95b17a2a11581a38',
    'User-Agent': 'MijnSimyoFT/4.16.0  (iOS 18.3.1; iPhone13,4)',
    'X-Client-Platform': 'ios',
    'X-Client-Version': '4.16.0',
    'Content-Type': 'application/json'
};

// 更新状态显示
function updateStatus() {
    document.getElementById('sessionStatus').textContent = 
        state.sessionToken ? '已登录' : '未登录';
    document.getElementById('activationCodeStatus').textContent = 
        state.activationCode || '未获取';
}

// 1. 登录功能
async function login() {
    const payload = {
        phoneNumber: document.getElementById('phoneNumber').value,
        password: document.getElementById('password').value
    };

    try {
        const response = await fetch('https://appapi.simyo.nl/simyoapi/api/v1/sessions', {
            method: 'POST',
            headers: commonHeaders,
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        if(data.result?.sessionToken) {
            state.sessionToken = data.result.sessionToken;
            showResponse('loginResponse', data);
            updateStatus();
        } else {
            throw new Error('登录失败');
        }
    } catch (error) {
        showResponse('loginResponse', { error: error.message });
    }
}

// 2.1 申请更换ESIM
async function requestEsimChange() {
    const payload = {
        initialValidationMethod: "CUSTOMER_SERVICE",
        esim: true
    };

    try {
        const response = await fetch('https://appapi.simyo.nl/webapi/api/v1/settings/simcard', {
            method: 'POST',
            headers: {
                ...commonHeaders,
                'X-Session-Token': state.sessionToken
            },
            body: JSON.stringify(payload)
        });
        showResponse('deviceChangeResponse', await response.json());
    } catch (error) {
        showResponse('deviceChangeResponse', { error: error.message });
    }
}

// 2.3 验证码确认
async function verifyCode() {
    const code = document.getElementById('validationCode').value;
    const response = await fetch('https://appapi.simyo.nl/webapi/api/v1/esim/verify-code', {
        method: 'POST',
        headers: {
            ...commonHeaders,
            'X-Session-Token': state.sessionToken
        },
        body: JSON.stringify({ validationCode: code })
    });
    showResponse('deviceChangeResponse', await response.json());
}

// 3. 获取ESIM
async function getEsim() {
    try {
        const response = await fetch('https://appapi.simyo.nl/simyoapi/api/v1/esim/get-by-customer', {
            headers: {
                ...commonHeaders,
                'X-Session-Token': state.sessionToken
            }
        });
        const data = await response.json();
        if(data.result?.activationCode) {
            state.activationCode = data.result.activationCode;
            updateStatus();
        }
        showResponse('esimResponse', data);
    } catch (error) {
        showResponse('esimResponse', { error: error.message });
    }
}

// 4. 生成二维码
function generateQR() {
    if(!state.activationCode) {
        alert('请先获取activation code');
        return;
    }
    
    const qr = qrcode(0, 'M');
    qr.addData(`LPA:${state.activationCode}`);
    qr.make();
    
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = qr.createSvgTag({
        cellSize: 8,
        margin: 4
    });
}

// 显示响应结果
function showResponse(containerId, data) {
    const container = document.getElementById(containerId);
    container.textContent = JSON.stringify(data, null, 2);
    container.style.display = 'block';
}

// 初始化
updateStatus();
</script>
</body>
</html>
